<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jeleren.dao.IImageInfoDao">
    <insert id="add" parameterType="com.jeleren.bean.ImageInfo"  useGeneratedKeys="true"  keyProperty="id">
      insert into images (image, name, cates, user_id, description, keywords, if_active, add_time, like_num, collect_num, pattern
      ) value (#{image}, #{name}, #{cates}, #{user_id}, #{description}, #{keywords}, #{if_active}, #{add_time}, 0, 0, #{pattern})
        <!--<selectKey keyProperty="id" resultType="int" >-->
            <!--SELECT @@IDENTITY AS ID-->
        <!--</selectKey>-->
  </insert>
    <!--<insert id="add" parameterType="com.jeleren.bean.ImageInfo">-->
            <!--insert into images (image, name, cates, user_id, description, keywords, if_active, add_time, like_num, collect_num) value (#{image}, #{name}, #{cates}, #{user_id}, #{description}, #{keywords}, #{if_active}, #{add_time}, 0, 0)-->
    <!--</insert>-->
    <!--<select id="searchImage" resultType="com.jeleren.bean.ImageInfo">-->
        <!--SELECT DISTINCT images.*-->
        <!--FROM images-->
        <!--inner JOIN image_keywords ON images.id = image_keywords.id-->
        <!--<where>-->
            <!--<if test="sList.pattern!=null">-->
                <!--images.pattern = #{sList.pattern}-->
            <!--</if>-->
            <!--<if test="sList.cateList.size()>0">-->
                <!--and images.cates in-->
                <!--<foreach collection="sList.cateList" item="cate" open="(" separator="," close=")">-->
                    <!--#{cate}-->
                <!--</foreach>-->
            <!--</if>-->
            <!--<if test="sList.keyword!=null">-->
                <!--and image_keywords.keyword like concat('%',#{sList.keyword},'%')-->
            <!--</if>-->
        <!--</where>-->
        <!--order by images.add_time ${sList.seq}-->
    <!--</select>-->

    <!--搜索结果集合，一张图片一个用户信息-->
    <resultMap id="seachResult" type="com.jeleren.bean.ImageResult">
        <id property="id" column="image_id"/>
        <association property="user" javaType="com.jeleren.bean.UserInfo">
            <id property="id" column="id"/>
            <result property="image" column="user_image"/>
            <result property="username" column="username"/>
            <result property="upload_num" column="upload_num"/>
            <result property="fan_num" column="fan_num"/>
            <result property="download_num" column="download_num"/>
            <result property="description" column="u_description"/>
        </association>
        <association property="image" javaType="com.jeleren.bean.ImageInfo">
            <id property="id" column="image_id"/>
            <result property="image" column="image"/>
            <result property="name" column="name"/>
            <result property="keywords" column="keywords"/>
            <result property="cates" column="cates"/>
            <result property="description" column="description"/>
            <result property="add_time" column="add_time"/>
            <result property="like_num" column="like_num"/>
            <result property="collect_num" column="collect_num"/>
            <result property="if_active" column="if_active"/>
            <result property="user_id" column="user_id"/>
        </association>
    </resultMap>

    <select id="searchImage" resultMap="seachResult">
        SELECT DISTINCT images.id AS image_id,
        images.image,
        images.name,
        images.cates,
        images.description,
        images.keywords,
        images.pre_image,
        images.if_active,
        images.add_time,
        images.like_num,
        images.collect_num,
        images.user_id,

        u.username,
        u.image AS user_image,
        u.fan_num,
        u.follow_num,
        u.upload_num,
        u.download_num,
        u.description as u_description

        FROM images
        inner JOIN image_keyword ON images.id = image_keyword.image_id
        inner join userinfo u on images.user_id = u.id
        <where>
            <if test="sList.pattern!=null">
                images.pattern = #{sList.pattern}
            </if>
            <if test="sList.cateList !=null and sList.cateList.size()>0">
                and
                <foreach collection="sList.cateList" item="cate" open=" " separator="or" close=" ">
                    images.cates like concat('%',#{cate},'%')
                    --
                </foreach>
            </if>
            <if test="sList.keyword!=null">
                and ( image_keyword.keyword like concat('%',#{sList.keyword},'%') or
                images.description like concat('%',#{sList.keyword},'%') )
            </if>
        </where>
        order by images.add_time ${sList.seq}
    </select>

    <resultMap id="imageResult" type="com.jeleren.bean.ImageResult">
        <!--<id property="id" column="id"/>-->
        <result property="if_like" column="rela_id"/>
        <result property="if_follow"  column="id"/>
        <association property="user" javaType="com.jeleren.bean.UserInfo">
            <id property="id" column="id"/>
            <result property="image" column="user_image"/>
            <result property="username" column="username"/>
            <result property="upload_num" column="upload_num"/>
            <result property="fan_num" column="fan_num"/>
        </association>
        <association property="image" javaType="com.jeleren.bean.ImageInfo">
            <id property="id" column="image_id"/>
            <result property="image" column="image"/>
            <result property="name" column="name"/>
            <result property="keywords" column="keywords"/>
        </association>
    </resultMap>
    <select id="getMainImage" parameterType="int" resultMap="imageResult">
        select images.image,
        images.name,
        images.keywords,
        images.id as image_id,
        u.image as user_image,
        u.username,
        u.upload_num,
        u.fan_num,
        uil.rela_id,
        ur.id
        from images
        inner join image_group ig on images.id=ig.image_id
        inner join userinfo u on u.id=images.user_id
        left join user_image_like uil on uil.image_id=images.id and uil.user_id = #{user_id}
        left join user_rela ur on ur.user_id = u.id and ur.fan_id = #{user_id}
        where ig.group_id = #{group_id}
    </select>

    <select id="getImageInfo" parameterType="int" resultMap="imageResult">
        select images.image,
        images.name,
        images.keywords,
        images.id as image_id,
        u.image as user_image,
        u.username,
        u.upload_num,
        u.fan_num,
        uil.rela_id,
        ur.id
        from images
--         inner join image_group ig on images.id = ig.image_id
        inner join userinfo u on u.id=images.user_id
        left join user_image_like uil on uil.image_id=images.id and uil.user_id = #{user_id}
        left join user_rela ur on ur.user_id = u.id and ur.fan_id = #{user_id}
        where images.id = #{image_id}
    </select>
    <update id="editImageLikeNum">
        update images set
        <if test="record == 'delete'">
            like_num = like_num - 1
        </if>
        <if test="record == 'add'">
            like_num = like_num + 1
        </if>
        where id = #{image}
    </update>


    <!--
        下面这个 resumap 包括了所有的属性
        用于获得图片和用户信息，主要用于根据用户id搜索图片
        和 用于根据不同的状态搜索
    -->

    <resultMap id="imageAndUserResult" type="com.jeleren.bean.ImageAndUserResult">
        <association property="user" javaType="com.jeleren.bean.UserInfo">
            <id property="id" column="id"/>
            <result property="image" column="user_image"/>
            <result property="username" column="username"/>
            <result property="upload_num" column="upload_num"/>
            <result property="fan_num" column="fan_num"/>
            <result property="download_num" column="download_num"/>
            <result property="description" column="u_description"/>
        </association>
        <collection property="imageInfos" javaType="list" ofType="com.jeleren.bean.ImageInfo">
            <id property="id" column="image_id"/>
            <result property="image" column="image"/>
            <result property="name" column="name"/>
            <result property="keywords" column="keywords"/>
            <result property="cates" column="cates"/>
            <result property="description" column="description"/>
            <result property="add_time" column="add_time"/>
            <result property="like_num" column="like_num"/>
            <result property="collect_num" column="collect_num"/>
            <result property="if_active" column="if_active"/>
        </collection>
    </resultMap>

    <!--获得用户id上传的图片-->
    <select id="getUserImages" parameterType="int" resultMap="imageAndUserResult">
           SELECT  images.id AS image_id,
        images.image,
        images.name,
        images.cates,
        images.description,
        images.keywords,
        images.pre_image,
        images.if_active,
        images.add_time,
        images.like_num,
        images.collect_num,
        images.user_id,

        u.username,
        u.image AS user_image,
        u.fan_num,
        u.follow_num,
        u.upload_num,
        u.download_num,
        u.description as u_description

        FROM images
        INNER JOIN userinfo u ON u.id=images.user_id WHERE u.id = #{uid}
    </select>

    <!--根据不同的状态得到用户的图片-->
    <select id="getImagesByActive"  resultMap="imageAndUserResult">
      SELECT  images.id AS image_id,
        images.image,
        images.name,
        images.cates,
        images.description,
        images.keywords,
        images.pre_image,
        images.if_active,
        images.add_time,
        images.like_num,
        images.collect_num,
        images.user_id,

        u.username,
        u.image AS user_image,
        u.fan_num,
        u.follow_num,
        u.upload_num,
        u.download_num,
        u.description as u_description

        FROM images
        INNER JOIN userinfo u ON u.id=images.user_id WHERE if_active = #{if_active} AND u.id = #{uid}
    </select>

    <!--通过图片的active得到其数量-->
    <select id="getActiveNum" parameterType="_int" resultType="_int">
        SELECT
        COUNT(if_active)
        FROM images
        WHERE if_active = #{active_id}
    </select>


</mapper>