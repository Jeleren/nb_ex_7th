<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jeleren.dao.IImageInfoDao">
    <insert id="add" parameterType="com.jeleren.bean.ImageInfo" useGeneratedKeys="true" keyProperty="id">
      insert into images (image, name, cates, user_id, description, keywords, if_active, add_time, like_num, collect_num, pattern
      ) value (#{image}, #{name}, #{cates}, #{user_id}, #{description}, #{keywords}, #{if_active}, #{add_time}, 0, 0, #{pattern})
  </insert>

    <!--搜索结果集合，一张图片一个用户信息-->
    <resultMap id="search" type="com.jeleren.bean.ImageResult">
        <id property="id" column="image_id"/>
        <result property="if_like" column="rela_id"/>
        <result property="if_follow" column="ur_id"/>
        <association property="user" javaType="com.jeleren.bean.UserInfo">
            <id property="id" column="id"/>
            <result property="image" column="user_image"/>
            <result property="username" column="username"/>
            <result property="upload_num" column="upload_num"/>
            <result property="fan_num" column="fan_num"/>
            <result property="download_num" column="download_num"/>
            <result property="description" column="u_description"/>
        </association>
        <association property="image" javaType="com.jeleren.bean.ImageInfo">
            <id property="id" column="image_id"/>
            <result property="image" column="image"/>
            <result property="name" column="name"/>
            <result property="keywords" column="keywords"/>
            <result property="cates" column="cates"/>
            <result property="description" column="description"/>
            <result property="add_time" column="add_time"/>
            <result property="like_num" column="like_num"/>
            <result property="collect_num" column="collect_num"/>
            <result property="if_active" column="if_active"/>
            <result property="user_id" column="user_id"/>
            <result property="pattern" column="pattern"/>
        </association>
    </resultMap>

    <select id="searchImage" parameterType="com.jeleren.bean.SearchList" resultMap="search">
        SELECT DISTINCT images.id AS image_id,
        images.image,
        images.name,
        images.cates,
        images.description,
        images.keywords,
        images.pre_image,
        images.if_active,
        images.add_time,
        images.like_num,
        images.collect_num,
        images.user_id,
        images.pattern,

        u.username,
        u.id,
        u.image AS user_image,
        u.fan_num,
        u.follow_num,
        u.upload_num,
        u.download_num,
        u.description as u_description,

        uil.rela_id,
        ur.id as ur_id
        FROM images
        inner join userinfo u on images.user_id = u.id
        left join user_image_like uil on uil.image_id=images.id and uil.user_id = #{sList.user_id}
        left join user_rela ur on ur.user_id = u.id and ur.fan_id = #{sList.user_id}

        <where>
            images.if_active = 4
            <if test="sList.pattern!=null">
                images.pattern = #{sList.pattern}
            </if>
            <if test="sList.cate !=null">
                and images.cates LIKE CONCAT('%',#{sList.cate},'%')
            </if>
            <if test="sList.keyword!=null">
                and (images.keywords LIKE CONCAT('%',#{sList.keyword},'%')
                or images.description LIKE CONCAT('%',#{sList.keyword},'%')
                or images.cates LIKE CONCAT('%',#{sList.keyword},'%'))
            </if>
        </where>
        order by images.add_time ${sList.seq}

    </select>

    <resultMap id="imageResult" type="com.jeleren.bean.ImageResult">
        <id property="id" column="image_id"/>
        <result property="if_like" column="rela_id"/>
        <result property="if_follow" column="id"/>
        <association property="user" javaType="com.jeleren.bean.UserInfo">
            <id property="id" column="id"/>
            <result property="image" column="user_image"/>
            <result property="username" column="username"/>
            <result property="upload_num" column="upload_num"/>
            <result property="fan_num" column="fan_num"/>
        </association>
        <association property="image" javaType="com.jeleren.bean.ImageInfo">
            <id property="id" column="image_id"/>
            <result property="image" column="image"/>
            <result property="name" column="name"/>
            <result property="keywords" column="keywords"/>
            <result property="pattern" column="pattern"/>
            <result property="add_time" column="add_time"/>
            <result property="description" column="description"/>
            <result property="cates" column="cates"/>
            <result property="like_num" column="like_num"/>
        </association>
    </resultMap>
    <select id="getMainImage" parameterType="int" resultMap="imageResult">
        select images.image,
        images.name,
        images.keywords,
        images.add_time,
        images.cates,
        images.description,
        images.like_num,
        images.pattern,
        images.id as image_id,
        u.image as user_image,
        u.username,
        u.id,
        u.upload_num,
        u.fan_num,
        uil.rela_id,
        ur.id
        from images
        inner join image_group ig on images.id=ig.image_id
        inner join userinfo u on u.id=images.user_id
        left join user_image_like uil on uil.image_id=images.id and uil.user_id = #{user_id}
        left join user_rela ur on ur.user_id = u.id and ur.fan_id = #{user_id}
        where ig.group_id = #{group_id} and images.if_active = 4
    </select>

    <select id="getImageInfo" parameterType="int" resultMap="imageResult">
        select images.image,
        images.name,
        images.keywords,
        images.add_time,
        images.cates,
        images.description,
        images.pattern,
        images.id as image_id,
        u.image as user_image,
        u.username,
        u.upload_num,
        u.fan_num,
        uil.rela_id,
        ur.id
        from images
        inner join userinfo u on u.id=images.user_id
        left join user_image_like uil on uil.image_id=images.id and uil.user_id = #{user_id}
        left join user_rela ur on ur.user_id = u.id and ur.fan_id = #{user_id}
        where images.id = #{image_id}
    </select>
    <update id="editImageLikeNum">
        update images set
        <if test="record == 'delete'">
            like_num = like_num - 1
        </if>
        <if test="record == 'add'">
            like_num = like_num + 1
        </if>
        where id = #{image}
    </update>


    <!--
        下面这个 resumap 包括了所有的属性
        用于获得图片和用户信息，主要用于根据用户id搜索图片
        和 用于根据不同的状态搜索
    -->

    <resultMap id="imageAndUserResult" type="com.jeleren.bean.ImageAndUserResult">
        <association property="user" javaType="com.jeleren.bean.UserInfo">
            <id property="id" column="id"/>
            <result property="image" column="user_image"/>
            <result property="username" column="username"/>
            <result property="upload_num" column="upload_num"/>
            <result property="fan_num" column="fan_num"/>
            <result property="download_num" column="download_num"/>
            <result property="description" column="u_description"/>
        </association>
        <collection property="imageInfos" javaType="list" ofType="com.jeleren.bean.ImageInfo">
            <id property="id" column="image_id"/>
            <result property="image" column="image"/>
            <result property="name" column="name"/>
            <result property="keywords" column="keywords"/>
            <result property="cates" column="cates"/>
            <result property="description" column="description"/>
            <result property="add_time" column="add_time"/>
            <result property="like_num" column="like_num"/>
            <result property="collect_num" column="collect_num"/>
            <result property="if_active" column="if_active"/>
        </collection>
    </resultMap>

    <!--获得用户id上传的图片-->
    <select id="getUserImages" parameterType="int" resultMap="imageResult">
        select images.image,
        images.name,
        images.keywords,
        images.add_time,
        images.cates,
        images.description,
        images.pattern,
        images.id as image_id,

        u.username,
        u.image AS user_image,
        u.fan_num,
        u.upload_num,
        u.id,
        uil.rela_id
        FROM images
        INNER JOIN userinfo u ON u.id=images.user_id
        left join user_image_like uil on uil.image_id=images.id and uil.user_id = #{uid}
        WHERE u.id = #{uid}
    </select>

    <!--根据不同的状态得到用户的图片-->
    <select id="getImagesByActive" resultMap="imageAndUserResult">
      SELECT  images.id AS image_id,
        images.image,
        images.name,
        images.cates,
        images.description,
        images.keywords,
        images.pre_image,
        images.if_active,
        images.add_time,
        images.like_num,
        images.collect_num,
        images.user_id,

        u.username,
        u.image AS user_image,
        u.fan_num,
        u.follow_num,
        u.upload_num,
        u.download_num,
        u.description as u_description

        FROM images
        INNER JOIN userinfo u ON u.id=images.user_id WHERE if_active = #{if_active} AND u.id = #{uid}
    </select>

    <!--通过图片的active得到其数量-->
    <select id="getActiveNum" parameterType="_int" resultType="_int">
        SELECT
        COUNT(if_active)
        FROM images
        WHERE if_active = #{active_id}
    </select>

    <update id="updateImage" parameterType="com.jeleren.bean.ImageInfo">
        update images
        <trim prefix="set" suffixOverrides=",">
            <if test="imageInfo.cates != null"> cates = #{imageInfo.cates},</if>
            <if test="imageInfo.keywords != null"> keywords = #{imageInfo.keywords},</if>
            <if test="imageInfo.description != null"> description = #{imageInfo.description},</if>
            <if test="imageInfo.if_active != null"> if_active = #{imageInfo.if_active},</if>
        </trim>
        where id = #{imageInfo.id}
    </update>
</mapper>